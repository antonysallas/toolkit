{# roles/build_report_container/templates/03_index.j2 #}
{% extends "00_base.j2" %}

{% block breadcrumb %}
{% endblock %}

{% block content %}
{% include '02_search_filters.j2' with context %}

<div class="container mt-4"> {# Remove fluid for narrower width #}
  <section>
    <div class="text-center mb-5">
      <h1 class="display-4">Switch Firmware Patching Reports</h1>
    </div>

    <div class="reports-list">
      {% set report_files = found_reports.files | default([]) %}
      {% if report_files %}
      {% set grouped_reports = {} %}
      {% for report in report_files | sort(attribute='path', reverse=true) %}
      {% set path_parts = report.path.split('/') %}
      {% set date_folder = path_parts[-2] %}
      {% if date_folder not in grouped_reports %}
      {% set _ = grouped_reports.update({date_folder: []}) %}
      {% endif %}
      {% if grouped_reports[date_folder] is defined %}
      {% set _ = grouped_reports[date_folder].append(report) %}
      {% endif %}
      {% endfor %}

      {% for date, reports in grouped_reports.items() %}
      <div class="card mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <h2 class="h4 mb-0">{{ readable_date }}</h2>
          <button class="btn btn-link text-white collapse-toggle" data-bs-toggle="collapse"
            data-bs-target="#collapse-{{ readable_date }}">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div id="collapse-{{ date }}" class="collapse show">
          <div class="card-body">
            <div class="list-group report-items">
              {% for report in reports | sort(attribute='path') %}
              {% set report_name = report.path.split('/')[-1] %}
              <a href="{{ date }}/{{ report_name }}" class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-center">
                  <span>
                    {% if 'pre-patching' in report_name %}
                    <span class="badge bg-primary">Pre-Patching</span>
                    {% else %}
                    <span class="badge bg-success">Post-Patching</span>
                    {% endif %}
                    <span class="ms-2">{{ report_name.split('_')[0] }}</span>
                  </span>
                  <small class="text-muted">View Report &rarr;</small>
                </div>
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        <div id="collapse-{{ date }}" class="collapse show">
          <div class="card-body">
            <div class="list-group report-items" data-search-container>
              {% for report in reports | sort(attribute='path') %}
              {% set report_name = report.path.split('/')[-1] %}
              <a href="{{ date }}/{{ report_name }}" class="list-group-item list-group-item-action" data-searchable>
                <div class="d-flex justify-content-between align-items-center">
                  <span>
                    {% if 'pre-patching' in report_name %}
                    <span class="badge bg-primary">Pre-Patching</span>
                    {% else %}
                    <span class="badge bg-success">Post-Patching</span>
                    {% endif %}
                    <span class="ms-2">{{ report_name.split('_')[0] }}</span>
                  </span>
                  <small class="text-muted">View Report &rarr;</small>
                </div>
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="alert alert-info">No reports found</div>
      {% endif %}
    </div>
  </section>
</div>

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        document.querySelectorAll('[data-searchable]').forEach(item => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      });
    }

    // Collapse functionality
    document.querySelectorAll('.collapse-toggle').forEach(button => {
      button.addEventListener('click', function () {
        const icon = this.querySelector('i');
        icon.classList.toggle('fa-chevron-down');
        icon.classList.toggle('fa-chevron-up');
      });
    });
  });
</script>
{% endblock %}
{% endblock %}